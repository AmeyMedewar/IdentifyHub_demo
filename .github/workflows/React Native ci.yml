name: Backend CI

on:
  push:
    branches: [ dev ]
    paths:
      - 'Backend/**'
      - '.github/workflows/React Native ci.yml'
  pull_request:
    branches: [ dev, main ]
    paths:
      - 'Backend/**'
  workflow_dispatch:  # Manual trigger

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Build with Maven
      working-directory: ./Backend
      run: mvn clean compile -q
    
    - name: Run unit tests
      working-directory: ./Backend
      run: mvn test
      
    - name: Generate test coverage report
      working-directory: ./Backend
      run: mvn jacoco:report
      continue-on-error: true
      
    - name: Check test coverage
      working-directory: ./Backend
      run: |
        echo "Test Coverage Summary:"
        # Simple coverage check - can be enhanced with SonarQube later
        if [ -d "target/site/jacoco" ]; then
          echo "✅ Coverage report generated"
        else
          echo "⚠️  No coverage report found"
        fi
    
    - name: Validate Spring Boot application
      working-directory: ./Backend
      run: |
        echo "Validating Spring Boot structure..."
        # Check main application class
        if grep -q "@SpringBootApplication" src/main/java/com/ledgerly/LedgerlyApplication.java; then
          echo "✅ Spring Boot application found"
        else
          echo "❌ Spring Boot application not found"
          exit 1
        fi
        
        # Check for controllers
        CONTROLLER_COUNT=$(find src/main/java -name "*Controller.java" | wc -l)
        echo "✅ Found $CONTROLLER_COUNT controller(s)"